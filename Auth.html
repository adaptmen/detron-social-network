<!DOCTYPE html>
<html>
<head>
	<title>Detron Auth</title>
</head>
<body>
	<div id="main">
		<div id="auth">
			<h2 id="main-label">Вход</h2>
			<div id="phone-block" style="display: none">
				<label for="phone">Номер телефона</label>
				<input id="phone" name="phone" type="text" placeholder="Enter phone number...">
			</div>
			<div id="login-block">
				<label id="login-label" for="login" type="text">Логин</label>
				<input id="login" name="login" type="text" placeholder="Enter login...">
			</div>
			<div id="password-block">
				<label id="password-label" for="password" type="password">Пароль</label>
				<input id="password" name="password" type="password" placeholder="Enter password...">
			</div>
			<div id="code-block" style="display: none">
				<label for="code" type="password">Код</label>
				<input id="code" name="code" type="text" placeholder="Enter code...">
			</div>
			<br>
			<button id="btn-send">Войти</button>
			<br><br>
			<button id="btn-signup" onclick="signupView()">Зарегистрироваться</button>
			<button id="btn-login" onclick="loginView()" style="display: none">Войти</button>
			<button id="btn-forgot" onclick="forgotView()" style="display: none">Забыли пароль?</button>
			<h3 id="status-label" style="display: none;"></h3>
		</div>
	</div>
	<script
			  src="https://code.jquery.com/jquery-3.3.1.min.js"
			  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
			  crossorigin="anonymous"></script>
	<script>
		const SERVER_URL	= '176.119.158.61';

		var phone_input 	= document.getElementById("phone");
		var password_input 	= document.getElementById("password");
		var login_input 	= document.getElementById("login");
		var code_input 		= document.getElementById("code");

		var password_label 	= document.getElementById("password-label");
		var login_label 	= document.getElementById("login-label");
		var main_label 		= document.getElementById("main-label");
		var status_label 	= document.getElementById("status-label");

		var code_block 		= document.getElementById("code-block");
		var password_block 	= document.getElementById("password-block");
		var phone_block 	= document.getElementById("phone-block");
		var login_block 	= document.getElementById("login-block");

		var btn_send 		= document.getElementById("btn-send");
		var btn_signup 		= document.getElementById("btn-signup");
		var btn_forgot 		= document.getElementById("btn-forgot");
		var btn_login 		= document.getElementById("btn-login");

		function signupView() {
			main_label.innerHTML = 'Регистрация';
			btn_send.innerHTML = 'Зарегистрироваться';
			btn_signup.style.display = 'none';
			btn_login.style.display = 'inline-block';

			$(btn_send).off('click');

			$(btn_send).on('click', function(e) {
				$.ajax({
					url: '/auth/signup?login=' + login_input.value + '&password=' + password_input.value,
					type: "POST",
					success: function(response) {
						window.location = '/app';
					},
					error: function(data) {
						status_label.style.display = 'inline-block';
						status_label.innerHTML = JSON.stringify(data.response);
					}
				});
			});
		}

		function loginView() {
			main_label.innerHTML = 'Вход';
			btn_send.innerHTML = 'Войти';
			btn_login.style.display = 'none';
			btn_signup.style.display = 'inline-block';

			$(btn_send).off('click');

			$(btn_send).on('click', function(e) {
				$.ajax({
					url: '/auth/login?login=' + login_input.value + '&password=' + password_input.value,
					type: "POST",
					success: function(response) {
						window.location = '/app';
					},
					error: function(data) {
						status_label.style.display = 'inline-block';
						status_label.innerHTML = JSON.stringify(data.response);
					}
				});
			});
		}

		function forgotView() {
			main_label.innerHTML = 'Forgot';
			password_block.style.display = 'none';
			btn_send.innerHTML = 'Get code'
			btn_send.addEventListener("click", function(e) {
				send(SERVER_URL + ':4000/auth/p?phone=' + phone_input.value, function(status, response) {
					if (status == 200) {
						code_block.style.display = 'block';
						btn_send.addEventListener("click", function(e) {
							send(SERVER_URL + ':4000/auth/c?phone=' + phone_input.value + '&code=' +code_input.value, function(status, response) {
								if (status == 200) {
									code_block.style.display = 'none';
									phone_block.style.display = 'none';
									password_label.innerHTML = 'New password';

									let token = response;

									btn_send.addEventListener("click", function(e) {
										send(SERVER_URL + ':4000/auth/np?phone=' + phone_input.value + '&password=' + password_input.value + '?t' + token, function(status, response) {
											if (status == 200) {
												let token_n = response;
												window.location = SERVER_URL + '?t=' + String(token_n);
											}
										});
									});
								}
							});
						});
					}
				});
			});
		}

		$(btn_send).on("click", function(e) {
			$.ajax({
				url: '/auth/login?login=' + login_input.value + '&password=' + password_input.value,
				type: "POST",
				success: function(response) {
					let token 		= response;
					window.location = '/app';
				},
				error: function(data) {
					status_label.style.display = 'inline-block';
					status_label.innerHTML = JSON.stringify(data.response);
				}
			});
		});
	</script>
	<style>
		html, body, #main {
			height: 100%;
			width: 100%;
			margin: 0;
			padding: 0;
		}

		#auth {
			grid-area: 2/2/2/2;
			text-align: center;
		}

		#main {
			background-color: #10213d;
			color: #ffffff;
			display: grid;
			grid-template: 1fr 2fr 1fr / 1fr 2fr 1fr;
		}
	</style>
</body>
</html>